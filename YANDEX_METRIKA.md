# Яндекс.Метрика в FinDash

Подробное описание интеграции Яндекс.Метрики: зачем она нужна, что считается, как устроена, как запустить и что смотреть в отчётах.

---

## Содержание

1. [Что это и зачем](#1-что-это-и-зачем)
2. [Что именно считается](#2-что-именно-считается)
3. [Архитектура интеграции](#3-архитектура-интеграции)
4. [Какие файлы задействованы](#4-какие-файлы-задействованы)
5. [Как запустить по шагам](#5-как-запустить-по-шагам)
6. [Как работает код](#6-как-работает-код)
7. [Параметры инициализации](#7-параметры-инициализации)
8. [Что смотреть в кабинете Метрики](#8-что-смотреть-в-кабинете-метрики)
9. [Дополнительно: цели и события](#9-дополнительно-цели-и-события)
10. [Устранение неполадок](#10-устранение-неполадок)

---

## 1. Что это и зачем

**Яндекс.Метрика** — сервис веб-аналитики. Он собирает данные о том, как пользователи ведут себя на сайте: сколько заходят, какие страницы открывают, как долго смотрят, куда кликают, откуда пришли.

**В FinDash Метрика нужна**, чтобы:

- видеть **полную статистику по проекту**: посещения, просмотры, отказы, глубину просмотра;
- понимать, **какие разделы** (Dashboard, Tracking, Reports) используют чаще;
- анализировать **поведение** (карта кликов, вебвизор — записи сессий);
- при необходимости настраивать **цели** (например: «пользователь скачал отчёт») и считать конверсии.

Без Метрики мы не видим, как реально используется приложение; с ней — есть цифры и записи сессий для принятия решений.

---

## 2. Что именно считается

| Данные | Описание |
|--------|----------|
| **Визиты** | Заходы на сайт (сессии). Один пользователь может сделать несколько визитов за день. |
| **Просмотры (хиты)** | Открытие страницы или «виртуальная страница» (в SPA мы сами отправляем хит при смене маршрута). |
| **Глубина просмотра** | Сколько просмотров за один визит (например: 5 страниц за заход). |
| **Время на сайте** | Как долго пользователь был на сайте в рамках визита. |
| **Отказы** | Визиты, в которых был только один просмотр и пользователь ушёл. Параметр `accurateTrackBounce` даёт более точный учёт. |
| **Источники** | Откуда пришли (поиск, ссылка, прямое заход и т.д.). |
| **Карта кликов** | Где на странице чаще всего кликают (включено через `clickmap: true`). |
| **Вебвизор** | Запись сессии: воспроизведение движений мыши, скролла, кликов (включено через `webvisor: true`). |
| **Переходы по ссылкам** | Клики по внешним ссылкам (включено через `trackLinks: true`). |

В SPA (как FinDash) без дополнительной настройки Метрика видела бы только один «просмотр» — загрузку приложения. Поэтому мы при каждой смене маршрута отправляем **виртуальный хит** с URL страницы — так в отчётах появляются отдельные «страницы».

**Маршруты FinDash, которые попадают в Метрику:** `/` (вход), `/confirm`, `/dashboard`, `/tracking`, `/reports`. Любой другой путь перенаправляется на `/`, поэтому в отчёте «Содержание» будут в основном эти URL.

---

## 3. Архитектура интеграции

Упрощённая схема:

```
Пользователь открывает FinDash (SPA)
         │
         ▼
  React-приложение загружается
         │
         ▼
  Компонент YandexMetrika монтируется (внутри BrowserRouter)
         │
         ├──► Загружается скрипт https://mc.yandex.ru/metrika/tag.js
         │
         ├──► Вызывается ym(COUNTER_ID, "init", params)
         │         → счётчик инициализирован, начинается сбор данных
         │
         └──► При каждой смене маршрута (pathname/search)
                   вызывается ym(COUNTER_ID, "hit", url)
                   → в Метрику уходит «просмотр страницы» с нужным URL
         │
         ▼
  Данные уходят на серверы Яндекс.Метрики
         │
         ▼
  В кабинете metrika.yandex.ru доступны отчёты и вебвизор
```

Важно:

- Счётчик **не** встроен в HTML вручную — им управляет React-компонент.
- ID счётчика берётся из переменной окружения `VITE_YANDEX_METRIKA_ID`, чтобы не хранить его в коде и иметь разные счётчики для dev/prod при необходимости.
- Компонент рендерится **внутри** `BrowserRouter`, чтобы иметь доступ к `useLocation()` и реагировать на смену маршрута.

---

## 4. Какие файлы задействованы

| Файл | Назначение |
|------|------------|
| `frontend/src/components/YandexMetrika.tsx` | Компонент: загрузка tag.js, инициализация счётчика, отправка хитов при смене `location`. |
| `frontend/src/App.tsx` | Подключение: импорт и рендер `<YandexMetrika />` внутри `<BrowserRouter>`. |
| `frontend/src/vite-env.d.ts` | Типы: объявление переменной `VITE_YANDEX_METRIKA_ID` для TypeScript. |
| `frontend/.env` | Конфигурация: здесь задаётся `VITE_YANDEX_METRIKA_ID=XXXXXXXX` (ID счётчика). Рекомендуется добавить `.env` в `.gitignore`, чтобы ID не попал в репозиторий. |

Скрипт Метрики (`tag.js`) подгружается с домена `mc.yandex.ru` динамически из компонента, в `index.html` его подключать не нужно.

---

## 5. Как запустить по шагам

### Шаг 1. Создать счётчик в Яндекс.Метрике

1. Зайди на [metrika.yandex.ru](https://metrika.yandex.ru).
2. Войди по аккаунту Яндекса (или создай его).
3. Нажми **«Добавить счётчик»**.
4. Укажи:
   - **Название** — например: «FinDash» или «FinDash Production».
   - **Адрес сайта** — URL, на котором крутится приложение (например `https://your-app.ru` или для теста `http://localhost:5173`).
5. При необходимости отключи/включи опции (по умолчанию можно оставить как есть) и нажми **«Создать счётчик»**.
6. На странице счётчика скопируй **номер счётчика** — это число вида `12345678`. Оно и есть **ID счётчика**.

### Шаг 2. Задать ID в проекте

1. В корне **фронтенда** создай или открой файл `.env` (путь: `frontend/.env`).
2. Добавь строку (подставь свой ID вместо `12345678`):

   ```env
   VITE_YANDEX_METRIKA_ID=12345678
   ```

3. Сохрани файл.  
   Важно: переменные с префиксом `VITE_` в Vite доступны в коде как `import.meta.env.VITE_YANDEX_METRIKA_ID`.

### Шаг 3. Перезапустить фронтенд

1. Останови dev-сервер (Ctrl+C в терминале, где запущен `npm run dev`).
2. Запусти снова из каталога `frontend`:

   ```bash
   cd frontend
   npm run dev
   ```

После этого при открытии приложения компонент прочитает ID, подгрузит tag.js и инициализирует счётчик. Данные начнут уходить в Метрику.

### Проверка

- Открой приложение в браузере, перейди по разделам (например: вход → Confirm → Dashboard → Tracking → Reports).
- В кабинете Метрики через некоторое время (обычно минуты) появятся визиты и просмотры; в отчёте «Содержание» должны быть URL: `/`, `/confirm`, `/dashboard`, `/tracking`, `/reports`.

### Чек-лист запуска

- [ ] Счётчик создан на [metrika.yandex.ru](https://metrika.yandex.ru), ID скопирован.
- [ ] В `frontend/.env` добавлена строка `VITE_YANDEX_METRIKA_ID=...` (без кавычек, только число).
- [ ] Dev-сервер фронтенда перезапущен (`npm run dev` в каталоге `frontend`).
- [ ] Приложение открыто в браузере, выполнены переходы по разделам.
- [ ] В кабинете Метрики выбран нужный период; через несколько минут появились визиты и просмотры.

---

## 6. Как работает код

### Инициализация (один раз при монтировании)

1. Компонент проверяет наличие `VITE_YANDEX_METRIKA_ID` в `import.meta.env`. Если переменной нет или она пустая — дальше ничего не происходит.
2. Если ID есть — проверяется, что это число (парсинг через `Number(COUNTER_ID)`).
3. Проверяется, есть ли уже в окне функция `window.ym` (например, скрипт tag.js был загружен ранее). Если есть — сразу вызываются `ym(id, "init", defaultParams)` и отправка хита для текущей страницы (чтобы первый просмотр не терялся).
4. Если `ym` ещё нет — создаётся тег `<script src="https://mc.yandex.ru/metrika/tag.js" async>`, вставляется в `document.head`. После `onload` вызываются `ym(id, "init", defaultParams)` и хит для текущего URL. На тег вешается `onerror`: при ошибке загрузки скрипта (сеть, блокировщик) приложение не падает, метрика просто не работает.
5. В `useEffect` при размонтировании скрипт удаляется из DOM (cleanup).

### Отправка хитов при смене маршрута

1. Компонент использует хук `useLocation()` из React Router и получает текущие `pathname` и `search`.
2. В отдельном `useEffect` зависимости — `[location.pathname, location.search]`. При их изменении (переход на другую страницу/другой query) формируется полный URL: `window.location.origin + pathname + search`.
3. Вызывается `window.ym(counterId, "hit", url)`. Метрика воспринимает это как просмотр страницы с данным URL.
4. В отчётах Метрики эти URL отображаются как отдельные «страницы», так что видно, какие разделы FinDash смотрят чаще.

Компонент ничего не рендерит в DOM (`return null`), он нужен только для побочных эффектов (инициализация и хиты).

---

## 7. Параметры инициализации

В коде задаётся объект `defaultParams`:

| Параметр | Значение | Что делает |
|----------|----------|------------|
| `clickmap` | `true` | Включает сбор карты кликов (где на странице кликают). |
| `trackLinks` | `true` | Отслеживание кликов по внешним ссылкам. |
| `accurateTrackBounce` | `true` | Более точный расчёт отказов (учёт времени на сайте). |
| `webvisor` | `true` | Включает вебвизор — запись сессий для последующего просмотра. |

Их можно менять в `frontend/src/components/YandexMetrika.tsx` в объекте `defaultParams`. Полный список параметров инициализации описан в [документации Метрики](https://yandex.ru/support/metrica/objects/init-params.html).

---

## 8. Что смотреть в кабинете Метрики

После того как данные начнут поступать:

- **Сводка** — визиты, просмотры, отказы, время на сайте за выбранный период.
- **Содержание** — список «страниц» (URL). Должны быть пути вроде `/`, `/dashboard`, `/tracking`, `/reports` — это наши виртуальные хиты.
- **Источники** — откуда приходят пользователи (поиск, переход по ссылке и т.д.).
- **Карта кликов** — на какой странице и куда чаще кликают.
- **Вебвизор** — запись сессий: движение мыши, скролл, клики. Помогает понять, как пользователи реально пользуются интерфейсом.

Данные обычно появляются с задержкой от нескольких минут; вебвизор и карта кликов могут обрабатываться дольше.

---

## 9. Дополнительно: цели и события

Сейчас в коде только **инициализация** и **хиты** при смене маршрута. При необходимости можно отправлять цели (например: «скачан отчёт», «добавлена валюта в избранное»).

Пример вызова цели:

```ts
if (typeof window.ym === "function" && import.meta.env.VITE_YANDEX_METRIKA_ID) {
  const id = Number(import.meta.env.VITE_YANDEX_METRIKA_ID);
  window.ym(id, "reachGoal", "report_downloaded");
}
```

Цели настраиваются в кабинете Метрики (Настройки → Цели). Идентификатор цели (например `report_downloaded`) должен совпадать с тем, что передаётся во втором аргументе `reachGoal`. Так можно считать конверсии по нужным действиям.

---

## 10. Устранение неполадок

| Проблема | Что проверить |
|----------|----------------|
| Данные не появляются в Метрике | Есть ли в `frontend/.env` строка `VITE_YANDEX_METRIKA_ID=...` и перезапущен ли dev-сервер после её добавления. |
| В отчёте только один URL (главная) | Компонент должен быть внутри `BrowserRouter` и использовать `useLocation()`. Убедись, что `<YandexMetrika />` в `App.tsx` внутри `<BrowserRouter>`. |
| Ошибки в консоли про `ym` | Убедись, что не блокируешь скрипты с `mc.yandex.ru` (расширения, блокировщики рекламы). В режиме инкогнито без расширений проверь ещё раз. |
| Разные окружения (dev/prod) | Для каждого окружения можно завести свой счётчик и в `.env` (или в настройках сборки) задать свой `VITE_YANDEX_METRIKA_ID`. |

Если ID не задан или не число — компонент не подгружает скрипт и не вызывает `ym`, приложение продолжает работать как раньше, без аналитики.

---

## Краткая шпаргалка

- **Зачем:** полная статистика по проекту — визиты, просмотры разделов, отказы, вебвизор, карта кликов.
- **Где код:** `frontend/src/components/YandexMetrika.tsx` + подключение в `App.tsx`.
- **Что настроить:** счётчик на metrika.yandex.ru → скопировать ID → в `frontend/.env` добавить `VITE_YANDEX_METRIKA_ID=ID` → перезапустить `npm run dev`.
- **Что считается:** визиты, просмотры (в т.ч. виртуальные страницы SPA), глубина, время, отказы, источники, клики, вебвизор — всё это смотри в кабинете Метрики.

Если нужно добавить цели или изменить параметры инициализации — правки делаются в `YandexMetrika.tsx` и при необходимости в местах вызова `ym(..., "reachGoal", ...)`.

---

## См. также

- [README.md](./README.md) — обзор проекта, стек, установка, API и краткий блок про аналитику.
